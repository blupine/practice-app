name: Build and Deploy by Tag

on:
  push:
    # 'ëª¨ë“ˆëª…@ë²„ì „' í˜•ì‹ì˜ íƒœê·¸ê°€ í‘¸ì‹œë  ë•Œë§Œ ì‹¤í–‰
    tags:
      - '*@*'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. íƒœê·¸ì—ì„œ ëª¨ë“ˆëª…ê³¼ ë²„ì „ ë¶„ë¦¬ (ì˜ˆ: webflux-cache@0.1)
      - name: Extract Module and Version
        id: parse_tag
        run: |
          # GITHUB_REF_NAMEì€ 'webflux-cache@0.1' ê°™ì€ íƒœê·¸ëª…ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.
          TAG_NAME=${GITHUB_REF_NAME}
          MODULE_NAME=$(echo $TAG_NAME | cut -d'@' -f1)
          VERSION=$(echo $TAG_NAME | cut -d'@' -f2)
          
          echo "MODULE=$MODULE_NAME" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          echo "Building module: $MODULE_NAME with version: $VERSION"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 2. ì´ë¯¸ì§€ ë¹Œë“œ ë° íƒœê·¸ (ì¶”ì¶œí•œ ë²„ì „ì„ ì‚¬ìš©)
      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./${{ env.MODULE }}/Dockerfile
          push: true
          tags: |
            ghcr.io/blupine/${{ env.MODULE }}:latest
            ghcr.io/blupine/${{ env.MODULE }}:${{ env.VERSION }}
            
      # 3. k8s-homelab ì €ì¥ì†Œì— PR ìƒì„±í•˜ê¸°
      - name: Create Pull Request in k8s-homelab
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.K8S_HOMELAB_PAT }}
          repository: blupine/k8s-homelab
          branch: "deploy/${{ env.MODULE }}-${{ env.VERSION }}" # ìƒˆ ë¸Œëœì¹˜ ì´ë¦„
          base: main
          title: "ğŸš€ [Deploy] ${{ env.MODULE }} v${{ env.VERSION }}"
          body: |
            ## ë°°í¬ ì •ë³´
            - **ëª¨ë“ˆëª…**: ${{ env.MODULE }}
            - **ë²„ì „**: ${{ env.VERSION }}
            - **ìš”ì²­ì**: @${{ github.actor }}
            
            ì´ PRì€ GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            YAML ì„¤ì •ì„ í™•ì¸í•˜ì‹  í›„ ìŠ¹ì¸(Merge)í•˜ì‹œë©´ ArgoCDê°€ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
          commit-message: "chore: update ${{ env.MODULE }} image to ${{ env.VERSION }}"