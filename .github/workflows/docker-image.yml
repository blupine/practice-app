name: Build and Deploy by Tag

on:
  push:
    # 'ëª¨ë“ˆëª…@ë²„ì „' í˜•ì‹ì˜ íƒœê·¸ê°€ í‘¸ì‹œë  ë•Œë§Œ ì‹¤í–‰
    tags:
      - '*@*'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. íƒœê·¸ì—ì„œ ëª¨ë“ˆëª…ê³¼ ë²„ì „ ë¶„ë¦¬ (ì˜ˆ: webflux-cache@0.1)
      - name: Extract Module and Version
        id: parse_tag
        run: |
          # GITHUB_REF_NAMEì€ 'webflux-cache@0.1' ê°™ì€ íƒœê·¸ëª…ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.
          TAG_NAME=${GITHUB_REF_NAME}
          MODULE_NAME=$(echo $TAG_NAME | cut -d'@' -f1)
          VERSION=$(echo $TAG_NAME | cut -d'@' -f2)
          
          echo "MODULE=$MODULE_NAME" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          echo "Building module: $MODULE_NAME with version: $VERSION"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 2. ì´ë¯¸ì§€ ë¹Œë“œ ë° íƒœê·¸ (ì¶”ì¶œí•œ ë²„ì „ì„ ì‚¬ìš©)
      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./${{ env.MODULE }}/Dockerfile
          push: true
          tags: |
            ghcr.io/blupine/${{ env.MODULE }}:latest
            ghcr.io/blupine/${{ env.MODULE }}:${{ env.VERSION }}

      # 3. k8s-homelab ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: Checkout k8s-homelab
        uses: actions/checkout@v4
        with:
          repository: blupine/k8s-homelab
          token: ${{ secrets.K8S_HOMELAB_PAT }}
          path: k8s-homelab # k8s-homelab í´ë”ì— ë”°ë¡œ ë‹¤ìš´ë¡œë“œ

      # 4. yqë¥¼ ì´ìš©í•œ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
      - name: Update Image Tag
        run: |
          TARGET_FILE="k8s-homelab/apps/${{ env.MODULE }}/deployment.yaml"
          NEW_IMAGE="ghcr.io/blupine/${{ env.MODULE }}:${{ env.VERSION }}"
          
          # yqë¥¼ ì‚¬ìš©í•˜ì—¬ container nameì´ ëª¨ë“ˆëª…ê³¼ ì¼ì¹˜í•˜ëŠ” ìš”ì†Œì˜ image ê°’ì„ ë³€ê²½
          # ë§Œì•½ ì»¨í…Œì´ë„ˆ ì´ë¦„ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë‹ˆ, ì²« ë²ˆì§¸ ì»¨í…Œì´ë„ˆì˜ ì´ë¯¸ì§€ë¥¼ ë°”ê¾¸ëŠ” ì‹ìœ¼ë¡œ ì„¤ì •:
          yq -i ".spec.template.spec.containers[0].image = \"$NEW_IMAGE\"" $TARGET_FILE
          
          # [ì¤‘ìš”] íŒŒì¼ì´ ì§„ì§œ ë°”ë€Œì—ˆëŠ”ì§€ ëˆˆìœ¼ë¡œ í™•ì¸ (ë¡œê·¸ì— ì°í˜)
          echo "====ë³€ê²½ëœ ì´ë¯¸ì§€ ë¼ì¸ í™•ì¸===="
          grep "image:" $TARGET_FILE

      # 5. PR ìƒì„±
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.K8S_HOMELAB_PAT }}
          path: k8s-homelab # ë°˜ë“œì‹œ ì²´í¬ì•„ì›ƒí•œ ê²½ë¡œë¥¼ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤!
          branch: "deploy/${{ env.MODULE }}-${{ env.VERSION }}"
          base: main
          title: "ğŸš€ [Deploy] ${{ env.MODULE }} v${{ env.VERSION }}"
          commit-message: "chore: update ${{ env.MODULE }} image to ${{ env.VERSION }}"
          body: |
            ## ë°°í¬ ìë™í™” ì•Œë¦¼
            - ëª¨ë“ˆ: ${{ env.MODULE }}
            - ì‹ ê·œ ë²„ì „: ${{ env.VERSION }}
            
            ë‚´ìš©ì„ í™•ì¸í•˜ì‹  í›„ Merge í•´ì£¼ì„¸ìš”.